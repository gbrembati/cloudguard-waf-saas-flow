name: TFplan

on:
  pull_request:
    types: [opened]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
        contents: read
        pull-requests: write
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v3
        with:
          fetch-depth: 2
        
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6
        
      - id: getTerraformFiles
        name: Get Terraform State
        run: |
          $Repo = "${{ github.repository }}"
          $BaseUri = "https://api.github.com"
          $ArtifactUri = "$BaseUri/repos/$Repo/actions/artifacts"
          $Token = "${{ github.token }}" | ConvertTo-SecureString -AsPlainText
          Write-Host "Artifact URI = $($ArtifactUri): $($Token)"
          try {
            $RestResponse = Invoke-RestMethod -Authentication Bearer -Uri $ArtifactUri -Token $Token | Select-Object -ExpandProperty artifacts
            if ($RestResponse){
              $MostRecentArtifactURI = $RestResponse | Sort-Object -Property created_at -Descending | where name -eq "tfstate" | Select-Object -First 1 | Select-Object -ExpandProperty archive_download_url
              Write-Host "Most recent STATE artifact URI = $MostRecentArtifactURI"
              if ($MostRecentArtifactURI){
                Write-Host "Downloading artifact to state.zip"
                try {
                  Invoke-RestMethod -uri $MostRecentArtifactURI -Token $Token -Authentication bearer -outfile ./state.zip
                  Expand-Archive ./state.zip
                  Write-Host "Extracted state.zip"
                  Move-Item -Path ./state/terraform.tfstate -Destination ./01-web-apps/terraform.tfstate
                } catch {
                    Write-Host "Error downloading state artifact: $MostRecentArtifactURI"
                }
              }
              $MostRecentArtifactURI = $RestResponse | Sort-Object -Property created_at -Descending | where name -eq "tfstate-dns" | Select-Object -First 1 | Select-Object -ExpandProperty archive_download_url
              Write-Host "Most recent STATE-DNS artifact URI = $MostRecentArtifactURI"
              if ($MostRecentArtifactURI){
                Write-Host "Downloading artifact to state-dns.zip"
                try {
                  Invoke-RestMethod -uri $MostRecentArtifactURI -Token $Token -Authentication bearer -outfile ./state-dns.zip
                  Expand-Archive ./state-dns.zip
                  Write-Host "Extracted state-dns.zip"
                  Move-Item -Path ./state-dns/terraform.tfstate -Destination ./02-dns/terraform.tfstate
                } catch {
                    Write-Host "Error downloading state artifact: $MostRecentArtifactURI"
                }
              }

            }
          } catch {
            Write-Host "Error getting artifacts $($ArtifactUri): $($_.Exception.Message)"
          }
        shell: pwsh
        continue-on-error: true

      - name: print
        env:
            TF_VAR_POLICY_CLIENT_ID: ${{ secrets.TF_VAR_POLICY_CLIENT_ID }}
            TF_VAR_POLICY_SECRET_KEY: ${{ secrets.TF_VAR_POLICY_SECRET_KEY }}
            TF_VAR_APPSEC_CLIENT_ID: ${{ secrets.TF_VAR_APPSEC_CLIENT_ID }}
            TF_VAR_APPSEC_SECRET_KEY: ${{ secrets.TF_VAR_APPSEC_SECRET_KEY }}
            TF_VAR_CLOUDFLARE_DNS_API_TOKEN: ${{ secrets.TF_VAR_CLOUDFLARE_DNS_API_TOKEN }}
            TF_VAR_CLOUDFLARE_DNS_ZONEID: ${{ secrets.TF_VAR_CLOUDFLARE_DNS_ZONEID }}
            TF_VAR_profile_id: ${{ secrets.TF_VAR_PROFILE_ID }}
        run: |
          cd 01-webapps
          terraform init; terraform validate; 
          terraform plan -var publish=true -out=../tfplan -input=false -no-color
          terraform show -json ../tfplan > tfplan.json
          terraform apply -auto-approve  ../tfplan
          cd ..
          cd 02-dns
          terraform init; terraform validate; 
          terraform plan -out=../tfplan-dns -input=false -no-color
          terraform apply -auto-approve ../tfplan-dns 
          cd ..

      # generate plain output
      - run: terraform show -no-color tfplan > terraform.text

      # generate json output
      - run: terraform show -json tfplan > terraform.json

      - uses: ahmadnassri/action-terraform-report@v3
        with:
          # tell the action the plan outputs
          terraform-text: ${{ github.workspace }}/terraform.text
          terraform-json: ${{ github.workspace }}/terraform.json
          remove-stale-reports: true

      - name: Save TF plan
        uses: actions/upload-artifact@v3
        with:
          name: tfplan
          path: tfplan
        continue-on-error: true      

      - name: Save TF plan JSON
        uses: actions/upload-artifact@v3
        with:
          name: tfplanjson
          path: tfplan.json
        continue-on-error: true

      - name: Save TF state
        uses: actions/upload-artifact@v3
        with:
          name: tfstate
          path: 01-webapps/terraform.tfstate
        continue-on-error: true

      - name: Save TF state DNS
        uses: actions/upload-artifact@v3
        with:
          name: tfstate-dns
          path: 01-dns/terraform.tfstate
        continue-on-error: true